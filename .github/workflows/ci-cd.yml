name: Minecraft CI/CD

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Choose action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - deploy-only
          - bake/push
          - destroy

##############################
# Job 1: Build & Push Docker Images
##############################
jobs:
  build-and-push:
    if: ${{ github.event.inputs.action == 'deploy' || github.event.inputs.action == 'bake/push' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: ${{ secrets.GCP_REGION }}
      ZONE: ${{ secrets.GCP_ZONE }}
      SERVER_DIR: ./server
      API_DIR: ./api
      SERVER_IMAGE: itzg/minecraft-server:latest
      SIDECAR_IMAGE: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/minecraft-server/idle-monitor:latest
      API_IMAGE: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/minecraft-api/minecraft-api:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to GCP via WIF
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev

      - name: Build & Push Minecraft Server Image
        run: |
          docker build -t minecraft-server $SERVER_DIR
          docker tag minecraft-server $SERVER_IMAGE
          docker push $SERVER_IMAGE

      - name: Build & Push Sidecar Image
        run: |
          docker build -t idle-monitor $SERVER_DIR/sidecar
          docker tag idle-monitor $SIDECAR_IMAGE
          docker push $SIDECAR_IMAGE

      - name: Build & Push API Image
        run: |
          docker build -t minecraft-api $API_DIR
          docker tag minecraft-api $API_IMAGE
          docker push $API_IMAGE

##############################
# Job 2: Deploy / Destroy via Terraform
##############################
  terraform-deploy-or-destroy:
    if: ${{ github.event.inputs.action != 'bake/push' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: ${{ secrets.GCP_REGION }}
      ZONE: ${{ secrets.GCP_ZONE }}
      VM_NAME: minecraft-server
      CLOUD_RUN_SERVICE: minecraft-api
      TERRAFORM_DIR: ./terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to GCP via WIF
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          install_components: 'beta'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7

      - name: Terraform Init
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: terraform init

      - name: Terraform Apply or Destroy
        working-directory: ${{ env.TERRAFORM_DIR }}
        env: 
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ secrets.GCP_REGION }}
          TF_VAR_zone: ${{ secrets.GCP_ZONE }}
          TF_VAR_vm_name: minecraft-server
          TF_VAR_minecraft_image: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/minecraft-server/minecraft-server:latest
          TF_VAR_sidecar_image: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/minecraft-server/idle-monitor:latest
          TF_VAR_api_image: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/minecraft-api/minecraft-api:latest
        run: |
          if [ "${{ github.event.inputs.action }}" == "destroy" ]; then
            echo "Destroying all Terraform-managed resources..."
            terraform destroy -auto-approve
          else
            echo "Applying Terraform deployment..."
            terraform apply -auto-approve
          fi
