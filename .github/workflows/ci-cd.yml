name: Minecraft CI/CD

# Trigger manually from GitHub Actions UI
on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Choose action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - destroy

jobs:
  # ========================
  # CI: Build & Push Docker Images
  # ========================
  build-and-push:
    if: ${{ github.event.inputs.action == 'deploy' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation

    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: ${{ secrets.GCP_REGION }}
      ZONE: ${{ secrets.GCP_ZONE }}
      SERVER_DIR: ./server
      API_DIR: ./api
      SERVER_IMAGE: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/minecraft-server/minecraft-server:latest
      API_IMAGE: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/minecraft-api/minecraft-api:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Authenticate to GCP via WIF
      - name: Authenticate to GCP via WIF
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      # Configure Docker to push to Artifact Registry
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev

      # Build & tag Minecraft server image
      - name: Build & Tag Minecraft Server Image
        run: |
          docker build -t minecraft-server $SERVER_DIR
          docker tag minecraft-server $SERVER_IMAGE

      # Build & tag API image
      - name: Build & Tag API Image
        run: |
          docker build -t minecraft-api $API_DIR
          docker tag minecraft-api $API_IMAGE

      # Push all images
      - name: Push Docker Images
        run: |
          docker push $SERVER_IMAGE
          docker push $API_IMAGE

  # ========================
  # CD: Deploy or Destroy via Terraform
  # ========================
  deploy-or-destroy:
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: ${{ secrets.GCP_REGION }}
      ZONE: ${{ secrets.GCP_ZONE }}
      VM_NAME: minecraft-server
      CLOUD_RUN_SERVICE: minecraft-api
      TERRAFORM_DIR: ./terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Authenticate to GCP via WIF
      - name: Authenticate to GCP via WIF
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      # Setup gcloud
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          install_components: 'beta'

      # Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.7

      # Terraform init
      - name: Terraform Init
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: terraform init

      # Terraform Apply or Destroy
      - name: Terraform Apply/Destroy
        working-directory: ${{ env.TERRAFORM_DIR }}
        env: 
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ secrets.GCP_REGION }}
          TF_VAR_zone: ${{ secrets.GCP_ZONE }}
          TF_VAR_vm_name: minecraft-server
          TF_VAR_minecraft_image: europe-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/minecraft-server/minecraft-server:latest
          TF_VAR_api_image: europe-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/minecraft-api/minecraft-api:latest
        run: |
          if [ "${{ github.event.inputs.action }}" == "destroy" ]; then
            terraform destroy -auto-approve
          else
            terraform apply -auto-approve
          fi
